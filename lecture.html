<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Data Communication Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f2f5; padding:20px; }
    h1 { text-align:center; }
    .quiz-box { background:#fff; border:1px solid #ccc; padding:20px; margin:20px auto; max-width:650px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .question { font-size:20px; font-weight:bold; margin-bottom:15px; }
    .options label { display:block; margin-bottom:10px; font-size:16px; }
    button { margin-top:15px; padding:10px 20px; border:none; border-radius:8px; background:#0077cc; color:white; cursor:pointer; font-size:16px; }
    button:hover { background:#005fa3; }
    .result { font-size:18px; font-weight:bold; margin-top:20px; }
    .score-box { text-align:center; font-size:20px; font-weight:bold; margin-top:20px; }
  </style>
</head>
<body>
  <h1 id="quizTitle">Revision Quiz</h1>
  <div style="text-align:center; margin-bottom:20px;">
    <label for="importQuiz" style="font-size:16px; font-weight:bold;">Import Quiz File:</label>
    <input type="file" id="importQuiz" accept="application/json" style="margin-left:10px;">
  </div>
  <div class="quiz-box">
    <div style="margin-bottom:15px;">
      <label for="numQuestions">Number of questions in session:</label>
      <input type="number" id="numQuestions" min="1" value="5" style="width:60px;">
      <label for="sessionTime" style="margin-left:15px;">Timer (seconds):</label>
      <input type="number" id="sessionTime" min="1" value="60" style="width:60px;">
      <label for="modeSelect" style="margin-left:15px;">Mode:</label>
      <select id="modeSelect">
        <option value="review">Review at End</option>
        <option value="instant">Instant Answer</option>
      </select>
      <button onclick="startSession()">Start Session</button>
    </div>
    <div class="timer" id="timer" style="font-size:18px; color:#d32f2f; text-align:right; margin-bottom:10px;"></div>
    <div class="question" id="question">Loading question...</div>
    <div class="options" id="options"></div>
  <button onclick="submitInstant()" id="submitBtn" style="display:none;">Submit</button>
  <button onclick="nextQuestion()" id="nextBtn">Next</button>
    <div class="result" id="result"></div>
  </div>
  <div class="score-box" id="scoreBox" style="display:none;"></div>

  <script>
    let quiz = [];
    // Load quiz data from quiz.json by default
    fetch('quiz.json')
      .then(response => response.json())
      .then(data => {
        quiz = data;
      })
      .catch(err => {
        console.error('Failed to load quiz data:', err);
        alert('Could not load quiz data.');
      });

    // Import quiz file from user's computer
    document.getElementById('importQuiz').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = JSON.parse(evt.target.result);
          quiz = data;
          // Set quiz title to file name without .json extension
          let name = file.name;
          if (name.toLowerCase().endsWith('.json')) {
            name = name.slice(0, -5);
          }
          document.getElementById('quizTitle').textContent = name;
          alert('Quiz imported successfully!');
        } catch (err) {
          alert('Invalid quiz file. Please select a valid JSON file.');
        }
      };
      reader.readAsText(file);
    });


    let sessionActive = false;
    let sessionQuestions = [];
    let sessionIndex = 0;
  let score = 0;
  let total = 0;
  let userAnswers = [];
    let timer = null;
    let timeLeft = 0;
    let mode = "review";
    function startSession() {
      document.getElementById("submitBtn").style.display = "none";
      const n = parseInt(document.getElementById("numQuestions").value);
      const customTime = parseInt(document.getElementById("sessionTime").value);
      mode = document.getElementById("modeSelect").value;
      if (isNaN(n) || n < 1 || n > quiz.length) {
        alert("Please enter a valid number of questions.");
        return;
      }
      if (isNaN(customTime) || customTime < 1) {
        alert("Please enter a valid timer value.");
        return;
      }
      sessionActive = true;
      score = 0;
      total = 0;
      sessionIndex = 0;
      userAnswers = [];
  sessionQuestions = shuffle(quiz).slice(0, n).map(q => randomizeOptions(q));
    // Randomize options and update answer index, preserving explanation
    function randomizeOptions(q) {
      const opts = q.options.map((opt, idx) => ({opt, idx}));
      for (let i = opts.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [opts[i], opts[j]] = [opts[j], opts[i]];
      }
      const newOptions = opts.map(o => o.opt);
      const newAnswer = opts.findIndex(o => o.idx === q.answer);
      // Copy explanation and any other fields
      return {
        q: q.q,
        options: newOptions,
        answer: newAnswer,
        explanation: q.explanation
      };
    }
      document.getElementById("nextBtn").disabled = false;
      document.getElementById("result").textContent = "";
      document.getElementById("scoreBox").style.display = "none";
      document.getElementById("scoreBox").textContent = "";
      timeLeft = customTime;
      updateTimer();
      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) {
          endSession();
        }
      }, 1000);
      loadSessionQuestion();
    }

    function updateTimer() {
      document.getElementById("timer").textContent = sessionActive ? `⏰ Time left: ${timeLeft}s` : "";
    }

    function endSession() {
      sessionActive = false;
      document.getElementById("timer").textContent = "";
      document.getElementById("nextBtn").disabled = true;
      if (timer) clearInterval(timer);
      document.getElementById("scoreBox").style.display = "block";
      showReview();
    }

    function showReview() {
      let reviewHtml = `<h2>Review</h2><ul style='list-style:none;padding:0;'>`;
      let correctCount = 0;
      sessionQuestions.forEach((q, i) => {
        const userAns = userAnswers[i];
        const isCorrect = userAns === q.answer;
        if (isCorrect) correctCount++;
        reviewHtml += `<li style='margin-bottom:18px;'><strong>Q${i+1}:</strong> ${q.q}<br>`;
        if (userAns === undefined) {
          reviewHtml += `<span style='color:orange;'>Not submitted</span><br>`;
        }
        q.options.forEach((opt, idx) => {
          let style = '';
          if (idx === q.answer) style = 'color:green;font-weight:bold;';
          if (userAns !== undefined && idx === userAns && !isCorrect) style = 'color:red;';
          reviewHtml += `<span style='${style}'>${userAns !== undefined && idx === userAns ? '' : ''}${opt}${idx === q.answer ? ' (correct)' : ''}${userAns !== undefined && idx === userAns && !isCorrect ? ' (your answer)' : ''}</span><br>`;
        });
        // Show explanation for the answer
        if (q.explanation) {
          reviewHtml += `<div style='font-size:15px;color:#555;margin-top:5px;'>${q.explanation}</div>`;
      
        }
        reviewHtml += `</li>`;
      });
      reviewHtml += `</ul><div class='score-box'>Final Score: ${correctCount}/${sessionQuestions.length}</div>`;
      document.getElementById("question").innerHTML = "Session complete!";
      document.getElementById("options").innerHTML = reviewHtml;
      document.getElementById("scoreBox").textContent = "";
    }

    function loadSessionQuestion() {
      document.getElementById("result").textContent = "";
      if (!sessionActive || sessionIndex >= sessionQuestions.length) {
        endSession();
        return;
      }
      const q = sessionQuestions[sessionIndex];
      document.getElementById("question").textContent = `Q${sessionIndex+1}: ${q.q}`;
      let opts = "";
      if (mode === 'instant') {
        opts = q.options.map((opt, i) =>
          `<label><input type="radio" name="option" value="${i}"> ${opt}</label>`
        ).join("");
        document.getElementById("submitBtn").style.display = "inline-block";
        document.getElementById("submitBtn").disabled = false;
      } else {
        opts = q.options.map((opt, i) =>
          `<label><input type="radio" name="option" value="${i}"> ${opt}</label>`
        ).join("");
        document.getElementById("submitBtn").style.display = "none";
      }
      document.getElementById("options").innerHTML = opts;
      document.getElementById("scoreBox").style.display = "none";
    }

    function nextQuestion() {
      if (!sessionActive) return;
      if (mode === 'instant') {
        // Only allow next if answered
        if (userAnswers[sessionIndex] === undefined) {
          document.getElementById("result").textContent = "⚠️ Please select and submit an answer!";
          return;
        }
        document.getElementById("submitBtn").disabled = true;
      } else {
        const radios = document.getElementsByName("option");
        let chosen = -1;
        radios.forEach(r => { if (r.checked) chosen = parseInt(r.value); });
        if (chosen === -1) {
          document.getElementById("result").textContent = "⚠️ Please select an answer!";
          return;
        }
        userAnswers[sessionIndex] = chosen;
        if (chosen === sessionQuestions[sessionIndex].answer) {
          score++;
        }
      }
      sessionIndex++;
      if (sessionIndex < sessionQuestions.length) {
        loadSessionQuestion();
      } else {
        endSession();
      }
    }

    function submitInstant() {
      if (!sessionActive) return;
      if (userAnswers[sessionIndex] !== undefined) return; // already answered
      const radios = document.getElementsByName("option");
      let chosen = -1;
      radios.forEach(r => { if (r.checked) chosen = parseInt(r.value); });
      if (chosen === -1) {
        document.getElementById("result").textContent = "⚠️ Please select an answer!";
        return;
      }
      userAnswers[sessionIndex] = chosen;
      document.getElementById("submitBtn").disabled = true;
      let explanation = sessionQuestions[sessionIndex].explanation || "";
      if (chosen === sessionQuestions[sessionIndex].answer) {
        score++;
        document.getElementById("result").innerHTML = "✅ Correct!<br><span style='font-size:15px;color:#555;'>" + explanation + "</span>";
      } else {
        document.getElementById("result").innerHTML = "❌ Wrong! Correct: " + sessionQuestions[sessionIndex].options[sessionQuestions[sessionIndex].answer] + "<br><span style='font-size:15px;color:#555;'>" + explanation + "</span>";
      }
    }

    // Utility: shuffle array
    function shuffle(array) {
      let arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

  // Initial state: disable quiz controls until session starts
  document.getElementById("nextBtn").disabled = true;

  // Keyboard answer support: classic number keys and numpad
  document.addEventListener('keydown', function(e) {
    if (!sessionActive) return;
    // Only allow 1-9 (main keyboard and numpad) for answer selection
    let num = null;
    if (/^[1-9]$/.test(e.key)) {
      num = parseInt(e.key);
    } else if (e.code && e.code.startsWith('Numpad')) {
      let n = e.code.replace('Numpad', '');
      if (/^[1-9]$/.test(n)) num = parseInt(n);
    }
    if (num !== null) {
      // Select corresponding radio button if exists
      const radios = document.getElementsByName('option');
      if (num-1 < radios.length) {
        radios[num-1].checked = true;
        // Do NOT auto-submit in instant mode
      }
      return;
    }
    // Space or Enter: submit or go next in instant mode
    if (e.code === 'Space' || e.code === 'Enter') {
      if (mode === 'instant') {
        const radios = document.getElementsByName('option');
        let chosen = -1;
        radios.forEach(r => { if (r.checked) chosen = parseInt(r.value); });
        if (userAnswers[sessionIndex] === undefined) {
          // If not yet submitted, submit if selected
          if (chosen !== -1) {
            submitInstant();
          } else {
            document.getElementById("result").textContent = "⚠️ Please select an answer!";
          }
        } else {
          // Already submitted, go to next
          nextQuestion();
        }
      } else {
        // Review mode: go next if selected
        const radios = document.getElementsByName("option");
        let chosen = -1;
        radios.forEach(r => { if (r.checked) chosen = parseInt(r.value); });
        if (chosen !== -1) {
          nextQuestion();
        } else {
          document.getElementById("result").textContent = "⚠️ Please select an answer!";
        }
      }
      e.preventDefault();
    }
  });
  </script>
</body>
</html>
